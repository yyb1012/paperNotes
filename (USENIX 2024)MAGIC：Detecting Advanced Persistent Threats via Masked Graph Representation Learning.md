# 1. 之前工作的不足
- 统计方法仅基于异常值或稀有性，无法提取复杂行为之间的关系
- 对新型APT泛化能力弱
# 2. MAGIC模型设计
![[Pasted image 20250715171443.png]]
## 2.1 溯源图构建
### 多标签哈希
假设进程p属性为：
- 路径：`/usr/bin/bash`
- 用户：`root`
- 父进程id：1
这就构成了一个多属性组合的特征向量，然后使用快速哈希函数对多个属性值进行拼接，得到唯一索引

### 噪声消除
- 去除同类型边：如多条read，仅保留一条
- 融合边的初始特征：若 a→c 有三条 read、两条 write，最终得到一条$e_{ac}$边，其初始 embedding 是 5 条边的 embedding 平均值
## 2.2 图表示学习模块
![[Pasted image 20250715215738.png]]
### 掩码机制
- [i] 在训练时，**随机选择一部分节点**，将其初始特征 embedding 替换为掩码token，作为模型学习的“空白”。
- 迫使模型根据图结构和邻居节点特征，推理被掩码节点的真实特征
- 提高泛化能力
### 编码器
- [i] 使用多层GAT(Graph Attention Network)，每一层：
- 将节点本身、邻居节点、边的特征向量进行聚合
- 引入注意力机制来区别不同邻居的重要性
- 输出为：每个节点的新嵌入向量
### 解码器
- [i] 指导编码器更新参数：
- 掩码节点的特征重建：对被掩码的节点，重新生成其初始嵌入向量，并将相似度作为训练目标
## 2.3 检测模块
### K近邻搜索
- 将训练集构建为一个K-D Tree，为一个高效查询的树
- 找到测试样本$x$在训练集中前$k$个最近邻向量，记为集合$N_x$
### 相似度计算
使用欧式距离计算x与集合$N_x$中每个邻居的距离均值 `score`
### 筛选
将`score`与设定的阈值相比较
## 2.4 模型自适应机制
### 概念漂移
当系统中“正常行为模式”随着时间发生变化，导致原本训练出的模型失效的现象。
- 例如：系统部署了新的服务产生了一批新的日志，但是这种日志在训练集中没有出现过，模型可能判定为异常。
### 解决方法
在线增量更新：
- 新加入的**正常嵌入**会被添加到K-D Tree中
- 采用LRU删除最旧的样本

## 数据集
StreamSpot：审计日志，
Unicorn Wget：审计日志，未公开
DARPA E3